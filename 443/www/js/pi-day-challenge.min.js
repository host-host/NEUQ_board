function dist(n,t){return Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1]))}function cross(n,t){return n[0]*t[1]-n[1]*t[0]}function calculateCenter(){let n=points.map(n=>n[0]),t=points.map(n=>n[1]),i=Math.min(...n),r=Math.max(...n),u=Math.min(...t),f=Math.max(...t),e=(i+r)/2,o=(u+f)/2;return[e,o]}function calculateDiameter(){let n=points.map(n=>n[0]),i=Math.min(...n),r=Math.max(...n),t=points.map(n=>n[1]),u=Math.min(...t),f=Math.max(...t);return Math.max(r-i,f-u)}function drawTitleText(){let n=titleText;context.font=titleFontSize.toString()+"px "+fontFamily;context.textAlign="center";context.textBaseline="top";context.fillStyle=titleColor;context.fillText(n,canvasWidth/2,titleMarginTop)}function drawHighScoreText(){let n=highScoreText.replace("$score$",highScoreStr);context.font=highScoreFontSize.toString()+"px "+fontFamily;let r=context.measureText(n).width;context.textAlign="left";context.textBaseline="top";context.fillStyle=highScoreColor;let t=canvasWidth/2-r/2,i=titleMarginTop+titleFontSize*fontHeight+highScoreMarginTop;context.fillText(n.substring(0,highScoreNumberPos),t,i);context.textAlign="right";context.textBaseline="top";context.fillStyle=highScoreNumberColor;t=canvasWidth/2+r/2;i=titleMarginTop+titleFontSize*fontHeight+highScoreMarginTop;context.fillText(n.slice(highScoreNumberPos),t,i)}function drawScoreText(n,t,i){let r="";if(context.font=scoreFontSize.toString()+"px "+fontFamily,n=="invalid"){r=invalidText;context.textAlign="center";context.textBaseline="middle";context.fillStyle=scoreColor;let n=t[0];n-scoreTextMetrics.width/2<0&&(n=scoreTextMetrics.width/2);n+scoreTextMetrics.width/2>canvasWidth&&(n=canvasWidth-scoreTextMetrics.width/2);let u=t[1]+i*gradeFontSizeRatio*fontHeight/2;u=u+scoreMarginTopBottom+scoreFontSize*fontHeight/2+scorePaddingTopBottom;u=Math.min(u,canvasHeight-scoreMarginTopBottom-scoreFontSize*fontHeight/2-scorePaddingTopBottom);context.fillText(r,n,u)}else{r=scoreText.replace("$score$",n);let e=scoreTextMetrics.width;context.textAlign="left";context.textBaseline="middle";context.fillStyle=scoreColor;let u=t[0];u-scoreTextMetrics.width/2-scorePaddingLeftRight<0&&(u=scoreTextMetrics.width/2+scorePaddingLeftRight);u+scoreTextMetrics.width/2+scorePaddingLeftRight>canvasWidth&&(u=canvasWidth-scoreTextMetrics.width/2-scorePaddingLeftRight);u=u-e/2;let f=t[1]+i*gradeFontSizeRatio*fontHeight/2;f=f+scoreMarginTopBottom+scoreFontSize*fontHeight/2+scorePaddingTopBottom;f=Math.min(f,canvasHeight-scoreMarginTopBottom-scoreFontSize*fontHeight/2-scorePaddingTopBottom);context.fillText(r.substring(0,scoreNumberPos),u,f);context.textAlign="right";context.textBaseline="middle";context.fillStyle=scoreNumberColor;u=u+e;context.fillText(r.slice(scoreNumberPos),u,f)}}function drawScoreBg(n,t){let i=n[0];i-scoreTextMetrics.width/2-scorePaddingLeftRight<0&&(i=scoreTextMetrics.width/2+scorePaddingLeftRight);i+scoreTextMetrics.width/2+scorePaddingLeftRight>canvasWidth&&(i=canvasWidth-scoreTextMetrics.width/2-scorePaddingLeftRight);i=i-scoreTextMetrics.width/2-scorePaddingLeftRight;let r=n[1]+t*gradeFontSizeRatio*fontHeight/2;r=r+scoreMarginTopBottom;r=Math.min(r,canvasHeight-scoreMarginTopBottom-scoreFontSize*fontHeight-scorePaddingTopBottom*2);let u=scoreTextMetrics.width+2*scorePaddingLeftRight,f=scoreFontSize*fontHeight+2*scorePaddingTopBottom;context.globalAlpha=.6;context.fillStyle=scoreBgColor;context.fillRect(i,r,u,f);context.globalAlpha=1}function drawNewRecordText(n,t){let r=n[0]+scoreTextMetrics.width/2+scorePaddingLeftRight,i=n[1]+t*gradeFontSizeRatio*fontHeight/2;i=i+scoreMarginTopBottom;i=Math.min(i,canvasHeight-scoreMarginTopBottom-scoreFontSize*fontHeight-scorePaddingTopBottom*2);let u=newRecordText;context.font=newRecordFontSize.toString()+"px "+fontFamily;context.textAlign="right";context.textBaseline="bottom";context.fillStyle=newRecordColor;context.fillText(u,r,i)}function ar(){let n=0,t=points.length,i=0,u=0,o=points[0],r=points[t-1],f=Infinity,e=0;for(let n=0;n<t/5;n++)dist(points[n],r)<f&&(f=dist(points[n],r),e=n);points.splice(0,e);t=points.length;for(let i=0;i<t-1;i++)n+=dist(points[i],points[i+1]);if((n+=dist(points[0],points[t-1]),dist(o,r)/n>.15)||dist(points[0],r)/n>.15)return Infinity;for(let n=1;n<t-1;n++){let t=[points[n][0]-points[0][0],points[n][1]-points[0][1]],r=[points[n+1][0]-points[0][0],points[n+1][1]-points[0][1]];i+=cross(t,r)/2;u+=Math.abs(cross(t,r)/2)}return(i=Math.abs(i),i/u<.85)?Infinity:n*n/i/4}function getScoreTextMetrics(){let n=scoreText.replace("$score$","3.000000");context.font=scoreFontSize.toString()+"px "+fontFamily;scoreTextMetrics=context.measureText(n)}function getGradeStr(n){for(let t=0;t<grade.length;t++)if(n<grade[t][0])return grade[t][1];return"F"}function drawGradeText(n,t,i){let r=getGradeStr(n),u=gradeText.replace("$grade$",r);context.font=(i*gradeFontSizeRatio).toString()+"px "+fontFamily;context.textAlign="center";context.textBaseline="middle";context.fillStyle=gradeColor;let f=t[0],e=t[1]+i*gradeFontSizeRatio*fontHeight*.08;context.fillText(u,f,e)}function getCurr(n){if(n.touches){let t=n.touches[0];currX=t.pageX-t.target.offsetLeft;currY=t.pageY-t.target.offsetTop;event.preventDefault()}else currX=n.clientX-canvas.offsetLeft,currY=n.clientY-canvas.offsetTop}function findxy(n,t){if(n=="down"&&fontLoaded&&(isPaint=!0,context.clearRect(0,0,canvasWidth,canvasHeight),drawTitleText(),drawHighScoreText(),getCurr(t),prevX=currX,prevY=currY,points=[[currX,currY]]),isPaint&&(n=="up"||n=="out")&&(isPaint=!1,points.length>2)){let t=calculateCenter(),i=calculateDiameter(),r=ar(),n="";r!==Infinity?(n=r.toString().substring(0,8),n=n.padEnd(8,"0")):n="invalid";drawScoreBg(t,i);drawScoreText(n,t,i);drawGradeText(r,t,i);r<parseFloat(highScoreStr)&&(drawNewRecordText(t,i),highScoreStr=n,localStorage.setItem("draw_a_pi_high_score",highScoreStr))}isPaint&&n=="move"&&isPaint&&(getCurr(t),dist([currX,currY],[prevX,prevY])>pixelSize&&(context.beginPath(),context.moveTo(prevX,prevY),context.lineTo(currX,currY),context.closePath(),context.stroke(),points.push([currX,currY]),prevX=currX,prevY=currY))}var canvasWidth=window.innerWidth,canvasHeight=window.innerHeight,canvasSize=Math.min(canvasWidth,canvasHeight*.75),scoreTextMetrics,fontLoaded,highScoreStr,points,pixelSize,context;const fontFamily="MyFont",colors=["#048ABF","#BF4215","#F2B138","#048ABF","#455473"],titleText="π Day 挑战 - 用手画圆",titleFontSize=canvasSize*.06,titleMarginTop=canvasSize*.05,titleColor=colors[0],highScoreText="High Score: π = $score$",highScoreFontSize=canvasSize*.08,highScoreMarginTop=canvasSize*.02,highScoreColor=colors[4],highScoreNumberColor=colors[1],highScoreNumberPos=11,scoreText="Based on This Circle π = $score$",invalidText="You Call That a Circle? Try Again!",scoreFontSize=canvasSize*.05,scoreMarginTopBottom=canvasSize*.03,scorePaddingLeftRight=canvasSize*.03,scorePaddingTopBottom=canvasSize*.02,scoreColor=colors[4],scoreNumberColor=colors[1],scoreNumberPos=20,scoreBgColor="#f0f0f0",grade=[[3.15,"S+"],[3.16,"S"],[3.17,"A+"],[3.18,"A"],[3.2,"B+"],[3.3,"B"],[3.4,"C"],[4,"D"],[Infinity,"D-"]],gradeText="$grade$",gradeFontSizeRatio=.65,gradeColor=colors[3],newRecordText="New High Score!",newRecordFontSize=canvasSize*.05,newRecordColor=colors[2],newRecordBgColor=colors[2],lineColor=colors[4],lineWidth=canvasSize*.008,fontHeight=1.2;fontLoaded=!1;localStorage.getItem("draw_a_pi_high_score")===null&&localStorage.setItem("draw_a_pi_high_score","9.999999");highScoreStr=localStorage.getItem("draw_a_pi_high_score");points=[];pixelSize=Math.min(canvasWidth,canvasHeight)/120;canvas=document.getElementById("canvas");canvas.width=canvasWidth;canvas.height=canvasHeight;canvas.addEventListener("mousemove",function(n){findxy("move",n)},!1);canvas.addEventListener("mousedown",function(n){findxy("down",n)},!1);canvas.addEventListener("mouseup",function(n){findxy("up",n)},!1);canvas.addEventListener("touchstart",function(n){findxy("down",n)},!1);canvas.addEventListener("touchmove",function(n){findxy("move",n)},!1);canvas.addEventListener("touchend",function(n){findxy("up",n)},!1);context=canvas.getContext("2d");context.strokeStyle=lineColor;context.lineJoin="round";context.lineWidth=lineWidth;context.globalCompositeOperation="source-over";document.fonts.load("20px MyFont").then(function(){getScoreTextMetrics();drawTitleText();drawHighScoreText();fontLoaded=!0});var isPaint=!1,prevX=0,prevY=0,currX=0,currY=0;